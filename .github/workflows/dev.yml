name: Continuous Integration and Deployment

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
        - name: Configure ssh connection
          shell: bash
          env:
            SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            SSH_KNOWN_HOST: ${{ secrets.SSH_KNOWN_HOSTS }}
            DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
            DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
          run: |
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
            eval $(ssh-agent -s)
            echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
            ssh ${DEPLOY_USER}@${DEPLOY_HOST} "source $HOME/.bashrc && echo $(/usr/bin/which pm2)"
            # ssh ${DEPLOY_USER}@${DEPLOY_HOST} $(/usr/bin/which pm2) status
